---
title: "Recruitment Funnel Analysis"
author: "Daniel Procter"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    number_offset: 0
    fig_caption: true
    self_contained: true
output_file: "report.html"
---

```{r set-up, include=FALSE}

# Install and load required packages (install if missing)
packages <- c(
  "tidyverse",
  "psych",
  "emmeans",
  "performance",
  "knitr", 
  "kableExtra",
  "scales",  
  "ggthemes"
)

installed <- packages %in% row.names(installed.packages())

if (any(!installed)) {
  install.packages(packages[!installed])
}

lapply(packages, library, character.only = TRUE)

# knitr global chunk options
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE,
  fig.align = "left", fig.width = 8, fig.height = 5, dpi = 150,
  out.width = "90%"
)

# Plot defaults
theme_set(
  theme_economist() +
    theme(
      plot.title = element_text(size = 13, face = "bold", hjust = 0.5),
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 9),
      axis.title.x = element_text(margin = margin(t = 8)),
      axis.title.y = element_text(margin = margin(r = 8)),
      axis.ticks = element_line(),
      axis.line = element_line(color = "black"),
      panel.grid.minor = element_blank(),
      plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
      legend.position = "none"
    )
)

# Stage order used in tables/plots
stage_order <- c("Application","Screening","Interview","Offer","Hired")
stage_cols <- tolower(stage_order)

# Avoid scientific notation
options(scipen = 999)

```

## Introduction
This report explores a simulated recruitment dataset, with the aim of understanding how candidates move through the hiring funnel and what factors influence their chances of success. The analysis will focus on questions such as:

* How many candidates reach each stage, and where do the biggest drop-offs occur?
* Do recruiter performance or source of application affect outcomes?
* Do higher test scores improve the likelihood of being hired?
* Are some job roles or locations harder to fill than others?
* Which factors overall are most predictive of a candidate being hired?

The dataset tracks applicants through five stages: application, screening, interview, offer, and hire. For each candidate it includes:

* Recruiter `rec_id` – one of five recruiters.
* Job role `job_role` – four possible roles.
* Source `source` – LinkedIn, job boards, or the company careers page.
* Test score `score` – a 0–100 score mimicking results from application tests (e.g., psychometric assessments).
* Stage flags `application`, `screening`, `interview`, `offer`, `hired`) – binary indicators of progression.

The simulation includes parameters to reflect real-world variation. Candidate scores differ by source, recruiters vary in closing effectiveness, and progression rates depend on both scores and source.

Although the dataset was created programmatically, the analysis is approached as if it were newly provided, with the aim of uncovering patterns and drivers of hiring success.


## Data Checks & Preparation
Before beginning the analysis, it is important to confirm that the dataset is properly structured and suitable for use. Although the data were simulated, it is treated as if it were newly provided, and a set of basic checks are applied to ensure consistency and integrity.

```{r data-checks-initial, results='hide'}

# Loading dataset
df <- read.csv("../data/simulated_funnel_data.csv")

# Inspecting structure
str(df)

# Checking unique values in categorical columns
unique(df$rec_id)
unique(df$source)
unique(df$job_role)

# Storing factor levels
rec_levels <- c("R1","R2","R3","R4","R5")
source_levels <- c("LinkedIn","Job board","Careers page")
role_levels <- c("Software Engineer","HR Specialist","Data Analyst","Marketing Associate")

# Coercing column types
df <- df %>%
  mutate(rec_id = factor(rec_id, levels = rec_levels),
         source = factor(source, levels = source_levels),
         job_role = factor(job_role, levels = role_levels))

```

The checks focused on the following points:

* Candidate IDs are unique
* Test scores fall within the expected range of 0–100
* Stage flags contain only values of 0 or 1
* The number of candidates decreases at each stage of the funnel
* No missing values are present

```{r data-checks-logical}

# Checking unique candidate IDs
unique_id_check <- anyDuplicated(df$cand_id) == 0

# Checking score range (expected 0–100)
score_range <- range(df$score, na.rm = TRUE)
score_check <- score_range[1] >= 0 && score_range[2] <= 100

# Checking stage values in {0,1}
stage_value_check <- all(sapply(df[stage_cols], function(x) all(x %in% c(0,1))))

# Checking funnel monotonicity (totals non-increasing)
stage_totals   <- colSums(df[stage_cols])
stage_counts_check <- all(diff(stage_totals) <= 0)

# Checking for missing values
na_total <- sum(is.na(df))
na_check <- na_total <= 0

```

The table below summarises the results of these checks.

```{r data-checks-summary-table}

# Shape
n_rows <- nrow(df); n_cols <- ncol(df)

# Compact, professional summary
checks_summary <- tibble(
  Check = c("Dataset shape",
            "Unique candidate IDs",
            "Score range within 0–100",
            "Stage values restricted to {0,1}",
            "Funnel monotonicity (stage counts decrease)",
            "Missing values"), 
  
  Summary = c(
    paste(n_rows, "rows x", n_cols, "columns"),
    ifelse(unique_id_check, "No duplicates found", "Duplicates detected"),
    paste0("Observed range: ", paste(score_range, collapse = "–")),
    ifelse(stage_value_check, "All valid", "Invalid values present"),
    ifelse(all(diff(stage_totals) <= 0), "All stages monotonic", "Non-monotonic stage counts"),
    ifelse(na_total == 0, "None detected", paste(na_total, "missing values"))
  )
)

# Nicely formatted table
kable(checks_summary,
             caption = "Summary of Data Quality Checks",
             col.names = c("Check", "Summary"),
             align = "l") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

The dataset contains 2,500 rows and 12 columns, with no missing values. Candidate identifiers are unique, scores and dates fall within the expected ranges, and progression through the funnel follows the correct pattern.

Finally, the first few rows of the dataset are displayed below.

```{r data-top-rows}

# Print top rows
kable(head(df, 5), align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left") %>%
  column_spec(1:ncol(df), width = "auto", extra_css = "white-space: nowrap;")

```

## Analysis
This section analyses candidate progression through the recruitment process and explores the key factors influencing hiring outcomes.

It begins with an overview of the funnel and key variables, followed by deeper analysis of how scores, recruiters, sources, roles, and locations relate to hiring success. Together, these analyses provide the foundation for the predictive modelling in Section 4.

### Overall Funnel Counts & Conversion

```{r funnel-counts}

# Number of candidates
n_cand <- nrow(df)

# Counts per stage
stage_counts <- colSums(df[stage_cols])

# Table 1: share of total applicants
tbl_share <- tibble(Stage = stage_order,
                    Count = stage_counts,
                    Percentage = percent(stage_counts / n_cand))

# Table 2: conversion from previous stage
tbl_conv <- tibble(Stage = stage_order,
                   Conversion = c(NA, stage_counts[-1] / head(stage_counts, -1))) %>%
  mutate(Conversion = ifelse(is.na(Conversion), "--",
                        percent(Conversion, accuracy = 0.1)))
```

```{r funnel-share-table}

# Printing table
kable(tbl_share, caption = "Share of Total Applicants", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

```{r funnel-plot}

# Setting stage order
tbl_share$Stage <- factor(tbl_share$Stage, levels = stage_order)

# Stage plot
ggplot(tbl_share, aes(x = Stage, y = Count, fill = Stage)) +
  geom_col(color = "black", linewidth = 0.5) +
  geom_text(aes(label = Count), vjust = -0.3, size = 3.5) +
  scale_fill_economist() +
  scale_y_continuous(limits = c(0, 3000), expand = expansion(mult = c(0, 0.02))) +
  labs(title = "Applicant Volume by Stage", x = NULL, y = "Number of Candidates") +
  theme(legend.position = "none",
        axis.ticks.x = element_blank())

```

```{r funnel-conversion-table}

# Printing table
kable(tbl_conv, caption = "Conversion from Previous Stage", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

```{r funnel-conversion-plot}

# Converting table
tbl_conv_plot <- tbl_conv %>%
  mutate(Stage = factor(Stage, levels = stage_order),
         Conversion = suppressWarnings(as.numeric(gsub("%", "", Conversion)))) %>%
  filter(Stage != "Application")

# Conversion plot
ggplot(tbl_conv_plot, aes(x = Stage, y = Conversion, fill = Stage)) +
  geom_col(color = "black", linewidth = 0.5) +
  geom_text(aes(label = percent(Conversion / 100, accuracy = 0.1)), vjust = -0.3, size = 3.5) +
  scale_fill_economist() +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = c(0, 0.02))) +
  labs(title = "Conversion Rate by Stage", x = NULL, y = "Conversion (%)") +
  theme(legend.position = "none",
        axis.ticks.x = element_blank())

```

### Assessment Scores

#### Summary and Distributions

```{r score-summary-table}

# Summary table
tbl_scores <- describe(df$score) %>%
  select(mean, sd, median, min, max, range, se) %>%
  mutate(across(c(mean, sd, se), ~ round(.x, 2))) %>%
  rename_with(~ tools::toTitleCase(.x)) %>%
  as_tibble()

# Printing table
kable(tbl_scores, caption = "Summary Statistics for Candidate Test Scores", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

```{r score-histogram}

# Histogram
ggplot(df, aes(x = score)) +
  geom_histogram(aes(y = after_stat(count), fill = after_stat(count)),binwidth = 5, color = "black", boundary = 0) +
  scale_y_continuous(limits = c(0, 400), expand = expansion(mult = c(0, 0.05))) +
  labs(title = "Distribution of Candidate Test Scores", x = "Test Score", y = "Count") +
  theme(legend.position = "none")

```

#### Score and Hiring Success

```{r score-logistic-regression}

# Logistic regression
score_logreg <- glm(hired ~ score, data = df, family = "binomial")

# Model components
coef_summary <- summary(score_logreg)$coefficients
coef <- coef_summary["score", "Estimate"]
pval <- coef_summary["score", "Pr(>|z|)"]
odds_ratio <- exp(coef)
pct_increase <- (odds_ratio - 1) * 100
r2_value <- r2_nagelkerke(score_logreg)

# Table
tbl_score_logreg <- tibble(
  Predictor = "Score",
  Coefficient = round(coef, 3),
  `P-value` = round(pval, 4),
  `Odds Ratio` = round(odds_ratio, 3),
  `Odds Increase (%)` = round(pct_increase, 1),
  `Nagelkerke R2` = round(r2_value, 3)
 )

# Printing table
kable(tbl_score_logreg, caption = "Assessment Score Predicting Hiring Success", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

```{r score-logit-curve, warnings = FALSE}

# Predicted probabilities
score_pred_prob <- tibble(score = df$score,
                          pred_prob = predict(score_logreg, type = "response"))

# Plotting curve
ggplot(score_pred_prob, aes(x = score, y = pred_prob)) +
  stat_smooth(method = "glm", method.args = list(family = binomial()), se = TRUE) +
  scale_y_continuous(labels = percent_format(accuracy = 1),
                     expand = expansion(mult = c(0, 0.02))) +
  labs(title = "Hiring Probability vs. Score", x = "Assessment Score", y = "Predicted Probability")

```

```{r score-bands}

# Score bands  
df <- df %>%
  mutate(score_band = cut(score, breaks = c(0, 50, 65, 80, 101), 
                          labels = c("Low", "Moderate", "High", "Very High"), right = FALSE)) %>%
  relocate(score_band, .after = score)

# Score interpretation
tbl_score_levels <- tibble(
  `Score Range` = c("0–49", "50–64", "65–79", "80–100"),
  Interpretation = c("Low", "Moderate", "High", "Very High"))

# Print table
kable(tbl_score_levels, caption = "Score Band Interpretation", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

```{r score-bands-progression-plot}

# Pivoting data
tbl_band_stage <- df %>%
  group_by(score_band) %>%
  summarise(across(all_of(stage_cols[-1]), ~ mean(.x, na.rm = TRUE)), .groups = "drop") %>%
  pivot_longer(-score_band, names_to = "stage", values_to = "Proportion") %>%
  mutate(Stage = factor(stage, levels = stage_cols[2:5], labels = stage_order[2:5])) %>%
  rename(`Score Band` = score_band) %>%
  select(-stage)

# Grouped bar chart
ggplot(tbl_band_stage, aes(x = Stage, y = Proportion, fill = `Score Band`)) +
  geom_col(position = position_dodge(width = 0.72), color = "black") +
  scale_x_discrete(limits = stage_order[2:5]) +
  scale_y_continuous(labels = percent_format(accuracy = 1),
                     limits = c(0, 1),
                     expand = expansion(mult = c(0, 0.02))) +
  scale_fill_economist(name = NULL) +
  labs(title = "Stage Progression by Score Band", x = NULL, y = "Proportion") +
  theme(
    legend.position = "top",                 
    legend.justification = "center",
    legend.direction = "horizontal",
    legend.key.size = grid::unit(8, "pt"),          
    legend.text = element_text(size = 10),    
    legend.spacing.x = grid::unit(3, "pt"),         
    plot.title = element_text(margin = margin(b = 6)),
    axis.ticks.x = element_blank()
  )

```

#### Score by Recruiter

```{r score-by-recruiter-summary}

# Summary table
tbl_rec_scores <- describeBy(df$score, group = df$rec_id, mat = TRUE) %>%
  select(group1, n, mean, sd, median, min, max, range, se) %>%
  mutate(across(c(mean, sd, se), ~ round(.x, 2))) %>%
  rename(Recruiter = group1) %>%
  rename_with(~ tools::toTitleCase(.x)) %>%
  as_tibble()

# Printing table
kable(tbl_rec_scores,
      caption = "Summary Statistics for Candidate Scores by Recruiter",
      align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")
 
```

```{r score-by-recruiter-boxplot}

# Boxplot
ggplot(df, aes(x = rec_id, y = score, fill = rec_id)) + 
  geom_boxplot(alpha = 0.85, outlier.shape = 21, outlier.size = 2, outlier.alpha = 0.5, width = 0.7) + 
  scale_fill_economist(name = NULL) + 
  labs(title = "Distribution of Candidate Scores by Recruiter", x = "Recruiter", y = "Candidate Score") + 
  theme(legend.position = "none", axis.ticks.x = element_blank(), axis.line.x = element_blank())

```

```{r score-by-recruiter-anova}

# ANOVA
anova_rec <- aov(score ~ rec_id, data = df)

# Table
anova_rec_tbl <- tibble(
  `R1 mean` = round(mean(df$score[df$rec_id == "R1"]), 2),
  `R2 mean` = round(mean(df$score[df$rec_id == "R2"]), 2),
  `R3 mean` = round(mean(df$score[df$rec_id == "R3"]), 2),
  `R4 mean` = round(mean(df$score[df$rec_id == "R4"]), 2),
  `R5 mean` = round(mean(df$score[df$rec_id == "R5"]), 2),
  `F` = round(summary(anova_rec)[[1]][["F value"]][1], 2),
  df = summary(anova_rec)[[1]][["Df"]][1],
  p = round(summary(anova_rec)[[1]][["Pr(>F)"]][1], 3)
)

# Printing table
kable(anova_rec_tbl, caption = "Score by Recruiter ANOVA Results", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left") %>%
  column_spec(1:5, width = "6em") %>%
  column_spec(6:8, width = "4em")  

```

#### Score by Applicant Source

```{r score-by-source-summary}

# Summary table
tbl_src_scores <- describeBy(df$score, group = df$source, mat = TRUE) %>%
  select(group1, n, mean, sd, median, min, max, range, se) %>%
  mutate(across(c(mean, sd, se), ~ round(.x, 2))) %>%
  rename(`Source` = group1) %>%
  rename_with(~ tools::toTitleCase(.x)) %>%
  as_tibble()

# Printing table
kable(tbl_src_scores,
      caption = "Summary Statistics for Candidate Scores by Source",
      align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "center")

```

```{r score-by-source-boxplot}

# Boxplot
ggplot(df, aes(x = source, y = score, fill = source)) +
  geom_boxplot(alpha = 0.85, outlier.shape = 21, outlier.size = 2, outlier.alpha = 0.5, width = 0.7) +
  scale_fill_economist(name = NULL) +
  labs(title = "Distribution of Candidate Scores by Source", x = "Source", y = "Candidate Score") +
  theme(legend.position = "none", axis.ticks.x = element_blank(), axis.line.x = element_blank())

```

```{r score-by-source-anova}

# ANOVA
anova_src <- aov(score ~ source, data = df)

# Table
anova_src_tbl <- tibble(
  `LinkedIn mean` = round(mean(df$score[df$source == "LinkedIn"]), 2),
  `Job board mean` = round(mean(df$score[df$source == "Job board"]), 2),
  `Careers page mean` = round(mean(df$score[df$source == "Careers page"]), 2),
  `F` = round(summary(anova_src)[[1]][["F value"]][1], 2),
  df = summary(anova_src)[[1]][["Df"]][1],
  p = round(summary(anova_src)[[1]][["Pr(>F)"]][1], 3)
)

# Printing table
kable(anova_src_tbl, caption = "Score by Source ANOVA Results", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left") %>%
  column_spec(1:3, width = "6em") %>%
  column_spec(4:6, width = "4em")  

```

```{r score-by-role-summary}

# Summary table
tbl_role_scores <- describeBy(df$score, group = df$job_role, mat = TRUE) %>%
  select(group1, n, mean, sd, median, min, max, range, se) %>%
  mutate(across(c(mean, sd, se), ~ round(.x, 2))) %>%
  rename(`Job Role` = group1) %>%
  rename_with(~ tools::toTitleCase(.x)) %>%
  as_tibble()

# Printing table
kable(tbl_role_scores,
      caption = "Summary Statistics for Candidate Scores by Job Role",
      align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "center")

```

```{r score-by-role-boxplot}

# Boxplot
ggplot(df, aes(x = job_role, y = score, fill = job_role)) +
  geom_boxplot(alpha = 0.85, outlier.shape = 21, outlier.size = 2, outlier.alpha = 0.5, width = 0.7) +
  scale_fill_economist(name = NULL) +
  labs(title = "Distribution of Candidate Scores by Job Role", x = "Job Role", y = "Candidate Score") +
  theme(legend.position = "none", axis.ticks.x = element_blank(),
        axis.line.x = element_blank())

```

```{r score-by-role-anova}

# ANOVA
anova_role <- aov(score ~ job_role, data = df)

# Table
anova_role_tbl <- tibble(
  `SE mean` = round(mean(df$score[df$job_role == "Software Engineer"]), 2),
  `HR mean` = round(mean(df$score[df$job_role == "HR Specialist"]), 2),
  `DA mean` = round(mean(df$score[df$job_role == "Data Analyst"]), 2),
  `MA mean` = round(mean(df$score[df$job_role == "Marketing Associate"]), 2),
  `F` = round(summary(anova_role)[[1]][["F value"]][1], 2),
  df = summary(anova_role)[[1]][["Df"]][1],
  p = round(summary(anova_role)[[1]][["Pr(>F)"]][1], 3)
)

# Printing table
kable(anova_role_tbl, caption = "Score by Job Role ANOVA Results", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left") %>%
  column_spec(1:4, width = "6em") %>%
  column_spec(5:7, width = "4em")  

```

#### Score Analysis Summary

### Recruiter Performance

#### Overview of Recruiter Activity

```{r recruiter-candidate-counts}

# Barchart
ggplot(df, aes(x = rec_id, fill = rec_id)) +
  geom_bar(color = "black", linewidth = 0.5) +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.3, size = 3.5) +
  scale_fill_economist(name = NULL) +
  scale_y_continuous(limits = c(0, 650), breaks = seq(0, 650, 150), expand = expansion(mult = c(0, 0.02))) +
  labs(title = "Number of Candidates Managed by Recruiter", x = NULL, y = "Candidate Count") +
  theme(legend.position = "none", axis.ticks.x = element_blank())

```

```{r recruiter-hire-rate-table}

# Summary table
tbl_rec_hire <- df %>%
  group_by(rec_id) %>%
  summarise(Candidates = n(), Hired = sum(hired), `Hire Rate` = mean(hired)) %>%
  rename(Recruiter = rec_id) %>%  
  mutate(`Hire Rate` = percent(`Hire Rate`, accuracy = 0.1)) %>%
  select(Recruiter, Candidates, Hired, `Hire Rate`)

# Printing table
kable(tbl_rec_hire, caption = "Recruiter Hiring Outcomes", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

#### Recruiter by Source

```{r recruiter-source-distribution}

# Summary table
tbl_rec_source <- df %>%
  group_by(rec_id, source) %>%
  summarise(Candidates = n()) %>%
  group_by(rec_id) %>%
  mutate(Proportion = Candidates / sum(Candidates))

# Plot
ggplot(tbl_rec_source, aes(x = rec_id, y = Proportion, fill = source)) +
  geom_col(color = "black", linewidth = 0.5) +
   geom_text(
    aes(label = percent(Proportion, accuracy = 1)),
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 3
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1), expand = expansion(mult = c(0, 0.02))) +
  scale_fill_economist(name = NULL) +
  labs(title = "Distribution of Candidate Sources by Recruiter", x = "Recruiter", y = "Proportion of Candidates") +
  theme(
    legend.position = "top",                 
    legend.justification = "center",
    legend.direction = "horizontal",
    legend.key.size = grid::unit(8, "pt"),          
    legend.text = element_text(size = 10),    
    legend.spacing.x = grid::unit(3, "pt"),         
    plot.title = element_text(margin = margin(b = 6)),
    axis.ticks.x = element_blank())

```

```{r recruiter-logistic-regression}

# Logistic regression
recruiter_logreg <- glm(hired ~ rec_id, data = df, family = binomial)

# Coefficients matrix
coef_mat <- summary(recruiter_logreg)$coefficients

# Baseline recruiter
baseline_rec <- levels(df$rec_id)[1]

# Initial Table
comp_recruiter <- tibble(
  Predictor = rownames(coef_mat),
  Coefficient = coef_mat[, "Estimate"],
  `Std. Error` = coef_mat[, "Std. Error"],
  `Z value` = coef_mat[, "z value"],
  `P-value` = coef_mat[, "Pr(>|z|)"],
  `Odds Ratio` = exp(coef_mat[, "Estimate"]),
  `Odds Increase (%)` = (exp(coef_mat[, "Estimate"]) - 1) * 100) %>%
  filter(Predictor != "(Intercept)") %>%
  mutate(Recruiter = sub("^rec_id", "", Predictor),
         Recruiter = factor(Recruiter, levels = levels(df$rec_id))) %>%
  select(Recruiter, Coefficient:`Odds Increase (%)`) %>%
  arrange(Recruiter)

# Compute Nagelkerke R2
r2_recruiter <- round(r2_nagelkerke(recruiter_logreg), 3)

# Rounding
tbl_rec_logreg <- comp_recruiter %>%
  mutate(across(c(Coefficient, 
                  `Std. Error`, 
                  `Z value`, 
                  `P-value`, 
                  `Odds Ratio`, 
                  `Odds Increase (%)`),
                ~ round(.x, 3))
  )

# Printing table
kable(tbl_rec_logreg, caption = "Recruiter Predicting Hiring Success", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "left")

```

```{r recuiter-source-moderation-logistic-regression}

# Logistic regression
recruiter_logreg_mod <- glm(hired ~ rec_id * source, data = df, family = binomial)

# Estimated marginal means
emm_int <- emmeans(recruiter_logreg_mod, ~ rec_id * source, type = "response")

# EMM table
tbl_emm <- as.data.frame(emm_int) %>%
  transmute(
    Recruiter = rec_id,
    Source = source,
    `Predicted Hire Prob.` = round(prob, 3),
    `SE` = round(SE, 3),
    `95% CI Lower` = round(asymp.LCL, 3),
    `95% CI Upper` = round(asymp.UCL, 3)
  )

# Printing table
kable(tbl_emm, caption = "Model-adjusted hiring probabilities: Recruiter x Source", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "center")

```

```{r pairwise-tests-emm}

# Pairwise tests
pairs_by_rec <- contrast(emm_int, method = "pairwise", by = "rec_id", adjust = "tukey")
pairs_by_rec_out <- summary(pairs_by_rec, type = "response", infer = TRUE)

# Pairwise table
tbl_pairs <- as.data.frame(pairs_by_rec_out) %>%
  transmute(
    Recruiter = rec_id,
    Comparison = contrast,
    `Odds Ratio` = round(odds.ratio, 3),
    SE = round(SE, 3),
    `95% CI Lower` = round(asymp.LCL, 3),
    `95% CI Upper` = round(asymp.UCL, 3),
    `p-value` = round(p.value, 4)
  )

# Printing table
kable(tbl_pairs, caption = "Pairwise source comparisons within recruiters", align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "bordered"), position = "center")

```

```{r interaction-plot}

# Coercing to dataframe
plot_emm <- as.data.frame(emm_int)

# Gradient colour
econ_col <- economist_pal()(9)[3]

# Tile plot
ggplot(plot_emm, aes(x = source, y = rec_id, fill = prob)) + 
  geom_tile(color = "black", size = 0.4) + 
  geom_text(aes(label = percent(prob, accuracy = 0.1)), size = 3) + 
  scale_fill_gradient(low = "white", high = econ_col, labels = percent_format(accuracy = 1), guide = "none") + 
  labs(title = "Recruiter x Source: Model-adjusted Hire Probability", x = NULL, y = NULL) + 
  theme(panel.grid.major.y = element_blank(), 
        axis.line.x = element_blank(), 
        axis.title.x = element_blank(), 
        axis.title.y = element_blank(), 
        axis.ticks.x = element_blank(),
        plot.background = element_rect(fill = "white"))

```


```{r model-comparison}

model_comp <- anova(recruiter_logreg, recruiter_logreg_mod, test = "Chisq")
chi_sq <- round(model_comp$Deviance[2], 2)
df_diff <- model_comp$Df[2]
p_val <- round(model_comp$`Pr(>Chi)`[2], 3)

```

The model comparison showed that adding the recruiter x source interaction did not significantly improve model fit, χ²(`r df_diff`) = `r chi_sq`, *p* = `r p_val`.

#### Recruiter by Role

```{r recruiter-role-distribution}

# Summary table
tbl_rec_role <- df %>%
  group_by(rec_id, job_role) %>%
  summarise(Candidates = n(), .groups = "drop_last") %>%
  group_by(rec_id) %>%
  mutate(Proportion = Candidates / sum(Candidates))

# Plot
ggplot(tbl_rec_role, aes(x = rec_id, y = Proportion, fill = job_role)) +
  geom_col(color = "black", linewidth = 0.5) +
   geom_text(
    aes(label = percent(Proportion, accuracy = 1)),
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 3
  ) +
  scale_y_continuous(labels = percent_format(accuracy = 1), expand = expansion(mult = c(0, 0.02))) +
  scale_fill_economist(name = NULL) +
  labs(title = "Distribution of Candidate Sources by Recruiter", x = "Recruiter", y = "Proportion of Candidates") +
  theme(
    legend.position = "top",                 
    legend.justification = "center",
    legend.direction = "horizontal",
    legend.key.size = grid::unit(8, "pt"),          
    legend.text = element_text(size = 10),    
    legend.spacing.x = grid::unit(3, "pt"),         
    plot.title = element_text(margin = margin(b = 6)),
    axis.ticks.x = element_blank())

```

 
### Job Role Performance

#### Volume and Hire Rate by Role

#### Stage Conversion by Role

### Predictive Modelling

#### Multiple Logistic Regression

#### Model Comparisons

## Summary